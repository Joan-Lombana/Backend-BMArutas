name: âš™ï¸ Backend Deploy - NestJS (sin Docker, multi-microservicio)

on:
  push:
    branches:
      - main

jobs:
  deploy-backend:
    runs-on: ubuntu-latest

    steps:
      # -------------------------------
      # 1ï¸âƒ£ Clonar cÃ³digo
      # -------------------------------
      - name: ğŸ§© Checkout del cÃ³digo
        uses: actions/checkout@v4

      # -------------------------------
      # 2ï¸âƒ£ Configurar Node.js
      # -------------------------------
      - name: âš™ï¸ Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      # -------------------------------
      # 3ï¸âƒ£ Instalar dependencias y compilar cada microservicio
      # -------------------------------
      - name: ğŸ—ï¸ Construir microservicios NestJS
        run: |
          echo "ğŸš€ Iniciando compilaciÃ³n de microservicios..."

          SERVICES=("backend" "rutas-service" )

          for SERVICE in "${SERVICES[@]}"; do
            echo "âš™ï¸ Procesando $SERVICE..."
            cd backend/$SERVICE
            npm ci
            npm run build
            cd ../..
          done

          echo "âœ… Todos los microservicios fueron compilados correctamente."

      # -------------------------------
      # 4ï¸âƒ£ Configurar SSH
      # -------------------------------
      - name: ğŸ”‘ Configurar acceso SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.DEPLOY_KEY }}

      # -------------------------------
      # 5ï¸âƒ£ Subir los builds al servidor remoto
      # -------------------------------
      - name: ğŸšš Subir builds de microservicios
        run: |
          echo "ğŸ“¤ Subiendo microservicios al servidor..."
          SERVICES=("backend" "rutas-service" )

          for SERVICE in "${SERVICES[@]}"; do
            echo "â¬†ï¸ Enviando $SERVICE..."
            scp -o StrictHostKeyChecking=no -r backend/$SERVICE/dist ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}:/tmp/$SERVICE/
            scp -o StrictHostKeyChecking=no backend/$SERVICE/package*.json ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}:/tmp/$SERVICE/
          done

      # -------------------------------
      # 6ï¸âƒ£ Desplegar y reiniciar servicios en el servidor
      # -------------------------------
      - name: âš¡ Desplegar en servidor remoto
  env:
    ENV_FILE: ${{ secrets.ENV_FILE }}
  run: |
    ssh -o StrictHostKeyChecking=no ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} '
      echo "ğŸ§¹ Limpiando versiones anteriores..."
      SERVICES=("backend" "rutas-service")

      for SERVICE in "${SERVICES[@]}"; do
        echo "âš™ï¸ Desplegando $SERVICE..."
        rm -rf /var/www/joan_site/backend/$SERVICE
        mkdir -p /var/www/joan_site/backend/$SERVICE

        echo "ğŸ“¦ Moviendo nueva build..."
        mv /tmp/$SERVICE/* /var/www/joan_site/backend/$SERVICE/

        cd /var/www/joan_site/backend/$SERVICE

        echo "ğŸ§¾ Creando archivo .env para $SERVICE..."
        echo "$ENV_FILE" > .env

        echo "ğŸ“¦ Instalando dependencias de producciÃ³n..."
        npm install --omit=dev

        echo "ğŸ” Reiniciando PM2 para $SERVICE..."
        pm2 delete $SERVICE || true
        pm2 start dist/main.js --name $SERVICE --time
      done

      echo "âœ… Todos los microservicios han sido desplegados correctamente."
    '


