name: ğŸš€ Backend Deploy - NestJS

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    env:
      DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
      DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
      DB_HOST: ${{ secrets.DB_HOST }}
      DB_PORT: ${{ secrets.DB_PORT }}
      DB_NAME: ${{ secrets.DB_NAME }}
      DB_USER: ${{ secrets.DB_USER }}
      DB_PASS: ${{ secrets.DB_PASS }}
      JWT_SECRET: ${{ secrets.JWT_SECRET }}
      GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
      GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
      GOOGLE_CALLBACK_URL: ${{ secrets.GOOGLE_CALLBACK_URL }}
      ROUTES_SERVICE_URL: ${{ secrets.ROUTES_SERVICE_URL }}

    steps:
      - name: ğŸ§© Checkout del cÃ³digo
        uses: actions/checkout@v4

      - name: âš™ï¸ Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ğŸ—ï¸ Construir microservicios
        run: |
          # --- Backend principal ---
          cd backend
          npm ci
          npm run build

          # --- Servicio de rutas ---
          cd rutas-service
          npm ci
          npm run build
          cd ..

      - name: ğŸ”‘ Configurar SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.DEPLOY_KEY }}

      - name: ğŸ“¦ Empaquetar backend
        run: |
          cd backend
          tar -czf ../deploy.tar.gz \
            --exclude='Dockerfile' \
            --exclude='docker-compose.yml' \
            --exclude='rutas-service/Dockerfile' \
            --exclude='rutas-service/docker-compose.yml' \
            dist package.json package-lock.json tsconfig.json rutas-service
          cd ..

      - name: ğŸ› ï¸ Preparar directorio remoto
        run: |
          ssh -o StrictHostKeyChecking=no $DEPLOY_USER@$DEPLOY_HOST '
            mkdir -p /tmp/eco_backend/ && chmod 777 /tmp/eco_backend/
          '

      - name: ğŸšš Subir paquete al servidor
        run: scp -o StrictHostKeyChecking=no deploy.tar.gz $DEPLOY_USER@$DEPLOY_HOST:/tmp/eco_backend/

      - name: âš¡ Desplegar backend en servidor
        run: |
          ssh -o StrictHostKeyChecking=no $DEPLOY_USER@$DEPLOY_HOST '
            echo "ğŸ§¹ Limpiando /var/www/joan_site/backend..."
            mkdir -p /var/www/joan_site/backend
            rm -rf /var/www/joan_site/backend/*

            echo "ğŸ“¦ Desempaquetando backend..."
            tar -xzf /tmp/eco_backend/deploy.tar.gz -C /var/www/joan_site/backend/

            echo "ğŸ“ Generando archivo .env..."
            ENV_FILE=/var/www/joan_site/backend/.env
            > $ENV_FILE
            echo "DB_HOST=$DB_HOST" >> $ENV_FILE
            echo "DB_PORT=$DB_PORT" >> $ENV_FILE
            echo "DB_NAME=$DB_NAME" >> $ENV_FILE
            echo "DB_USER=$DB_USER" >> $ENV_FILE
            echo "DB_PASS=$DB_PASS" >> $ENV_FILE
            echo "JWT_SECRET=$JWT_SECRET" >> $ENV_FILE
            echo "GOOGLE_CLIENT_ID=$GOOGLE_CLIENT_ID" >> $ENV_FILE
            echo "GOOGLE_CLIENT_SECRET=$GOOGLE_CLIENT_SECRET" >> $ENV_FILE
            echo "GOOGLE_CALLBACK_URL=$GOOGLE_CALLBACK_URL" >> $ENV_FILE
            echo "ROUTES_SERVICE_URL=$ROUTES_SERVICE_URL" >> $ENV_FILE

            echo "ğŸ“¦ Instalando dependencias..."
            cd /var/www/joan_site/backend
            npm install --omit=dev

            # ğŸŒ± Ejecutar seeders desde dist/ (producciÃ³n)
            if [ -f dist/autenticacion/rol/seed/roles.seeder.js ]; then
              node dist/autenticacion/rol/seed/roles.seeder.js || true
            fi

            # ğŸ”¹ Backend principal
            pm2 delete backend || true
            pm2 start dist/src/main.js --name backend --time

            # ğŸ”¹ Servicio rutas
            cd /var/www/joan_site/backend/rutas-service
            npm install --omit=dev
            pm2 delete rutas-service || true
            pm2 start dist/main.js --name rutas-service --time

            pm2 save
            pm2 status
            echo "âœ… Todos los microservicios desplegados correctamente."
          '








