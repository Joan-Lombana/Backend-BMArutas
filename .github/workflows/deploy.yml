name: ğŸš€ Backend Deploy - NestJS

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ§© Checkout del cÃ³digo
        uses: actions/checkout@v4

      - name: âš™ï¸ Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ğŸ—ï¸ Construir backend y rutas-service
        run: |
          cd backend
          npm ci
          npm run build   # genera dist/src

          cd rutas-service
          npm ci
          npm run build   # ahora genera dist/src

          cd ../..

      - name: ğŸ”‘ Configurar SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.DEPLOY_KEY }}

      - name: ğŸ“¦ Empaquetar backend
        run: |
          cd backend
          tar -czf ../deploy.tar.gz \
            dist/src \
            rutas-service/dist/ \
            rutas-service/package.json \
            rutas-service/package-lock.json \
            package.json package-lock.json tsconfig.json
          cd ..

      - name: ğŸ› ï¸ Preparar directorio remoto
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} '
            mkdir -p /tmp/eco_backend/ && chmod 777 /tmp/eco_backend/
          '

      - name: ğŸšš Subir paquete al servidor
        run: |
          scp -o StrictHostKeyChecking=no deploy.tar.gz \
            ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}:/tmp/eco_backend/

      - name: âš¡ Desplegar en el servidor
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} '
            echo "â¬‡ï¸ Exportando variables de entorno..."
            export DB_HOST="${{ secrets.DB_HOST }}"
            export DB_PORT="${{ secrets.DB_PORT }}"
            export DB_NAME="${{ secrets.DB_NAME }}"
            export DB_USER="${{ secrets.DB_USER }}"
            export DB_PASS="${{ secrets.DB_PASS }}"
            export JWT_SECRET="${{ secrets.JWT_SECRET }}"
            export GOOGLE_CLIENT_ID="${{ secrets.GOOGLE_CLIENT_ID }}"
            export GOOGLE_CLIENT_SECRET="${{ secrets.GOOGLE_CLIENT_SECRET }}"
            export GOOGLE_CALLBACK_URL="${{ secrets.GOOGLE_CALLBACK_URL }}"
            export ROUTES_SERVICE_URL="${{ secrets.ROUTES_SERVICE_URL }}"

            echo "ğŸ§¹ Limpiando backend anterior..."
            mkdir -p /var/www/joan_site/backend
            rm -rf /var/www/joan_site/backend/*

            echo "ğŸ“¦ Extrayendo deploy.tar.gz..."
            tar -xzf /tmp/eco_backend/deploy.tar.gz -C /var/www/joan_site/backend/

            echo "ğŸ“ Creando .env..."
            ENV_FILE=/var/www/joan_site/backend/.env
            > $ENV_FILE
            echo "DB_HOST=$DB_HOST" >> $ENV_FILE
            echo "DB_PORT=$DB_PORT" >> $ENV_FILE
            echo "DB_NAME=$DB_NAME" >> $ENV_FILE
            echo "DB_USER=$DB_USER" >> $ENV_FILE
            echo "DB_PASS=$DB_PASS" >> $ENV_FILE
            echo "JWT_SECRET=$JWT_SECRET" >> $ENV_FILE
            echo "GOOGLE_CLIENT_ID=$GOOGLE_CLIENT_ID" >> $ENV_FILE
            echo "GOOGLE_CLIENT_SECRET=$GOOGLE_CLIENT_SECRET" >> $ENV_FILE
            echo "GOOGLE_CALLBACK_URL=$GOOGLE_CALLBACK_URL" >> $ENV_FILE
            echo "ROUTES_SERVICE_URL=$ROUTES_SERVICE_URL" >> $ENV_FILE

            echo "ğŸ“¦ Instalando dependencias..."
            cd /var/www/joan_site/backend
            npm install --omit=dev

            cd /var/www/joan_site/backend/rutas-service
            npm install --omit=dev

            echo "ğŸ” Reiniciando PM2..."
            pm2 delete backend || true
            pm2 delete rutas-service || true

            pm2 start /var/www/joan_site/backend/dist/src/main.js --name backend --time
            pm2 start /var/www/joan_site/backend/rutas-service/dist/main.js --name rutas-service --time

            pm2 save
            pm2 status

            echo "âœ… Deploy finalizado correctamente."
          '










