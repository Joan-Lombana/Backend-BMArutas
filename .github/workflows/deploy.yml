name: ğŸš€ Backend Deploy - NestJS

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ§© Checkout del cÃ³digo
        uses: actions/checkout@v4

      - name: âš™ï¸ Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ğŸ—ï¸ Construir backend y rutas-service
        run: |
          echo "ğŸ—ï¸ Construyendo backend..."
          cd backend
          npm ci
          npm run build
          cd ..

          echo "ğŸ—ï¸ Construyendo rutas-service..."
          cd rutas-service
          npm ci
          npm run build
          cd ..

      - name: ğŸ”‘ Configurar SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.DEPLOY_KEY }}

      - name: ğŸ“¦ Empaquetar build
        run: |
          tar -czf deploy.tar.gz \
            backend/dist \
            backend/package.json \
            backend/package-lock.json \
            rutas-service/dist \
            rutas-service/package.json \
            rutas-service/package-lock.json

      - name: ğŸ› ï¸ Preparar directorio remoto
        run: |
          ssh -o StrictHostKeyChecking=no \
            ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} \
            'mkdir -p /tmp/eco_backend/ && chmod 777 /tmp/eco_backend/'

      - name: ğŸšš Subir build al servidor
        run: |
          scp -o StrictHostKeyChecking=no deploy.tar.gz \
            ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}:/tmp/eco_backend/

      - name: âš¡ Desplegar en el servidor
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} '
            ROOT=/var/www/joan_site/BMArutas-Backend

            echo "ğŸ§¹ Limpiando deploy anterior..."
            rm -rf $ROOT
            mkdir -p $ROOT/backend
            mkdir -p $ROOT/rutas-service

            echo "ğŸ“¦ Extrayendo deploy.tar.gz..."
            tar -xzf /tmp/eco_backend/deploy.tar.gz -C $ROOT

            echo "ğŸ“¦ Instalando dependencias..."
            cd $ROOT/backend
            npm install --omit=dev

            cd $ROOT/rutas-service
            npm install --omit=dev

            echo "ğŸ” Reiniciando PM2..."
            pm2 delete backend || true
            pm2 delete rutas-service || true

            cd /var/www/joan_site/pm2
            pm2 start ecosystem.config.js --env production
            pm2 save

            pm2 status

            echo "âœ… Deploy finalizado correctamente."
          '















