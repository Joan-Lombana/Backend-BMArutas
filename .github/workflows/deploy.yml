name: ğŸš€ Backend Deploy - NestJS

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ§© Checkout del cÃ³digo
        uses: actions/checkout@v4

      - name: âš™ï¸ Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ğŸ—ï¸ Construir backend y rutas-service
        run: |
          echo "ğŸ—ï¸ Construyendo backend..."
          cd backend
          npm ci
          npm run build
          cd ..

          echo "ğŸ—ï¸ Construyendo rutas-service..."
          cd rutas-service
          npm ci
          npm run build
          cd ..

      - name: ğŸ”‘ Configurar SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.DEPLOY_KEY }}

      - name: ğŸ“¦ Empaquetar dist + package.json
        run: |
          tar -czf deploy.tar.gz \
            backend/dist \
            backend/package.json \
            backend/package-lock.json \
            rutas-service/dist \
            rutas-service/package.json \
            rutas-service/package-lock.json

      - name: ğŸ› ï¸ Preparar directorio remoto
        run: |
          ssh -o StrictHostKeyChecking=no \
          ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} \
          'mkdir -p /tmp/eco_backend/'

      - name: ğŸšš Subir paquete al servidor
        run: |
          scp -o StrictHostKeyChecking=no deploy.tar.gz \
          ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}:/tmp/eco_backend/

      - name: âš¡ Desplegar en el servidor
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} '
            ROOT=/var/www/joan_site/BMArutas-Backend

            echo "ğŸ§¹ Limpiando y recreando directorio..."
            rm -rf $ROOT
            mkdir -p $ROOT

            echo "ğŸ“¦ Extrayendo archivos..."
            tar -xzf /tmp/eco_backend/deploy.tar.gz -C $ROOT

            echo "ğŸ“¦ Instalando dependencias reales..."
            cd $ROOT/backend
            npm install --omit=dev
            cd $ROOT/rutas-service
            npm install --omit=dev

            echo "ğŸ” Reiniciando PM2 ..."

            pm2 delete backend || true
            pm2 delete rutas-service || true

            echo "ğŸ§¹ Eliminando dump viejo..."
            rm ~/.pm2/dump.pm2 || true

            echo "ğŸŒ Exportando variables de entorno..."
            export POSTGRES_USER=${{ secrets.POSTGRES_USER }}
            export POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
            export POSTGRES_DB=${{ secrets.POSTGRES_DB }}
            export DB_HOST=${{ secrets.DB_HOST }}
            export DB_PORT=${{ secrets.DB_PORT }}
            export ROUTES_SERVICE_URL=${{ secrets.ROUTES_SERVICE_URL }}
            export GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}
            export GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}
            export GOOGLE_CALLBACK_URL=${{ secrets.GOOGLE_CALLBACK_URL }}
            export JWT_SECRET=${{ secrets.JWT_SECRET }}
            export FRONTEND_URL=${{ secrets.FRONTEND_URL }}
            export PORT=${{ secrets.PORT }}

            # Iniciar BACKEND en modo PRODUCCIÃ“N
            NODE_ENV=production pm2 start $ROOT/backend/dist/src/main.js --name backend
            # Iniciar rutas-service tambiÃ©n en PRODUCCIÃ“N
            NODE_ENV=production pm2 start $ROOT/rutas-service/dist/main.js --name rutas-service

            pm2 save
            echo "ğŸ”¥ PM2 STATUS:"
            pm2 status

            echo "ğŸ‰ Deploy finalizado correctamente."

          '
















