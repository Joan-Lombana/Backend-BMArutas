name: üöÄ Backend Deploy

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Clonar repositorio
      - uses: actions/checkout@v4

      # 2Ô∏è‚É£ Configurar Node.js
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      # 3Ô∏è‚É£ Build microservicios
      - name: üèóÔ∏è Build backend y rutas-service
        run: |
          cd backend
          npm ci
          npm run build
          cd rutas-service
          npm ci
          npm run build
          cd ..

      # 4Ô∏è‚É£ Empaquetar builds
      - name: üì¶ Crear archivo deploy
        run: |
          tar -czf deploy.tar.gz -C backend backend rutas-service

      # 5Ô∏è‚É£ Subir y desplegar al servidor
      - name: ‚ö° Deploy en servidor remoto
        env:
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
        run: |
          scp deploy.tar.gz $DEPLOY_USER@$DEPLOY_HOST:/tmp/
          ssh $DEPLOY_USER@$DEPLOY_HOST << 'EOF'
            rm -rf /var/www/joan_site/backend/backend
            rm -rf /var/www/joan_site/backend/rutas-service
            mkdir -p /var/www/joan_site/backend
            tar -xzf /tmp/deploy.tar.gz -C /var/www/joan_site/backend/
            cd /var/www/joan_site/backend/backend
            npm install --omit=dev
            pm2 delete backend || true
            pm2 start dist/main.js --name backend --time
            cd ../rutas-service
            npm install --omit=dev
            pm2 delete rutas-service || true
            pm2 start dist/main.js --name rutas-service --time
            
            echo "‚úÖ Todos los microservicios desplegados correctamente."
          EOF
         



