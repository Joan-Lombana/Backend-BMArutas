name: üöÄ Backend Deploy

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: üì¶ Desplegar backend en servidor remoto
    runs-on: ubuntu-latest

    steps:
      # -------------------------------
      # 1Ô∏è‚É£ Clonar el repositorio
      # -------------------------------
      - name: üß© Checkout del c√≥digo
        uses: actions/checkout@v4

      # -------------------------------
      # 2Ô∏è‚É£ Configurar Node.js
      # -------------------------------
      - name: ‚öôÔ∏è Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # -------------------------------
      # 3Ô∏è‚É£ Instalar dependencias y construir los servicios
      # -------------------------------
      - name: üèóÔ∏è Build de microservicios
        run: |
          SERVICES=("backend" "rutas-service")
          for SERVICE in "${SERVICES[@]}"; do
            echo "üìÇ Construyendo $SERVICE..."
            cd $SERVICE
            npm install
            npm run build
            cd ..
          done

      # -------------------------------
      # 4Ô∏è‚É£ Crear archivo comprimido temporal
      # -------------------------------
      - name: üì¶ Empaquetar builds
        run: |
          mkdir -p /tmp/deploy
          SERVICES=("backend" "rutas-service")
          for SERVICE in "${SERVICES[@]}"; do
            cp -r $SERVICE/dist /tmp/deploy/$SERVICE
            cp -r $SERVICE/package*.json /tmp/deploy/$SERVICE
          done
          tar -czf deploy.tar.gz -C /tmp deploy

      # -------------------------------
      # 5Ô∏è‚É£ Enviar y desplegar al servidor remoto
      # -------------------------------
      - name: ‚ö° Desplegar en servidor remoto
        env:
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
        run: |
          echo "üöÄ Conectando con el servidor..."
          scp -o StrictHostKeyChecking=no deploy.tar.gz $DEPLOY_USER@$DEPLOY_HOST:/tmp/

          ssh -o StrictHostKeyChecking=no $DEPLOY_USER@$DEPLOY_HOST << 'EOF'
            echo "üßπ Limpiando versiones anteriores..."
            SERVICES=("backend" "rutas-service")

            for SERVICE in "${SERVICES[@]}"; do
              echo "‚öôÔ∏è Desplegando $SERVICE..."
              rm -rf /var/www/joan_site/backend/$SERVICE
              mkdir -p /var/www/joan_site/backend/$SERVICE
              tar -xzf /tmp/deploy.tar.gz -C /var/www/joan_site/backend/
              cd /var/www/joan_site/backend/$SERVICE
              echo "üì¶ Instalando dependencias de producci√≥n..."
              npm install --omit=dev

              echo "üîÅ Reiniciando PM2 para $SERVICE..."
              pm2 delete $SERVICE || true
              pm2 start dist/main.js --name $SERVICE --time
            done

            echo "‚úÖ Todos los microservicios desplegados correctamente."
         



